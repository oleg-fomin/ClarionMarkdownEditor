<!DOCTYPE html>
<html>
<head>
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta charset="utf-8">
    <title>Markdown Editor</title>
    <style>
        * { box-sizing: border-box; margin: 0; padding: 0; }
        html, body { height: 100%; font-family: 'Segoe UI', Tahoma, sans-serif; font-size: 14px; }

        .container { display: flex; flex-direction: column; height: 100%; background: #f5f5f5; }

        /* Formatting toolbar */
        .format-toolbar { display: flex; gap: 4px; padding: 4px 8px; background: #e8e8e8; border-bottom: 1px solid #ccc; }
        .format-toolbar button { padding: 3px 8px; border: 1px solid #aaa; background: #fff; cursor: pointer; font-size: 12px; border-radius: 3px; min-width: 28px; }
        .format-toolbar button:hover { background: #e0e0e0; }
        .format-toolbar button:active { background: #d0d0d0; }

        /* Print styles - hide everything except markdown preview */
        @media print {
            .tab-bar,
            .tab-context-menu,
            .format-toolbar,
            .editor-pane,
            .status-bar,
            .preview-pane .pane-header,
            .toggle-btn {
                display: none !important;
            }
            
            .container {
                background: white;
            }
            
            .preview-pane {
                border: none !important;
                margin: 0 !important;
                padding: 20px !important;
            }
            
            .preview-content {
                max-width: 100% !important;
                padding: 0 !important;
            }
            
            /* Ensure code blocks print well */
            pre {
                page-break-inside: avoid;
                border: 1px solid #ddd !important;
            }
        }

        /* Editor area */
        .editor-container { display: flex; flex: 1; overflow: hidden; }

        /* Editor pane */
        .editor-pane { flex: 1; display: flex; flex-direction: column; border-right: 1px solid #ccc; }
        .editor-pane .pane-header { 
            padding: 4px 8px; 
            background: #ddd; 
            font-size: 11px; 
            font-weight: bold; 
            color: #555; 
            height: 25px; 
            display: flex; 
            align-items: center;
        }
        .editor-pane textarea { 
            flex: 1; 
            width: 100%; 
            border: none; 
            resize: none; 
            padding: 10px; 
            font-family: 'Consolas', 'Courier New', monospace; 
            font-size: 14px; 
            line-height: 1.5; 
            outline: none; 
            white-space: pre; 
            overflow-x: auto; 
            overflow-y: auto; 
            word-wrap: normal;
        }

        /* Preview pane */
        .preview-pane { flex: 1; display: flex; flex-direction: column; overflow: hidden; }
        .preview-pane .pane-header { 
            padding: 4px 8px; 
            background: #ddd; 
            font-size: 11px; 
            font-weight: bold; 
            color: #555; 
            height: 25px; 
            display: flex; 
            justify-content: space-between; 
            align-items: center;
        }
        .preview-pane .pane-header .title { }
        .preview-pane .pane-header .toggle-btn { padding: 2px 6px; border: 1px solid #aaa; background: #fff; cursor: pointer; font-size: 10px; border-radius: 3px; line-height: 1; }
        .preview-pane .pane-header .toggle-btn:hover { background: #e0e0e0; }
        .preview-pane .preview-content { flex: 1; padding: 15px; overflow: auto; background: #fff; }

        /* Fullscreen preview mode */
        .editor-pane.hidden { display: none; }
        .preview-pane.fullscreen { flex: 1; border-left: none; }
        .format-toolbar.hidden { display: none; }

        /* Horizontal split mode (stacked top/bottom) */
        .editor-container.horizontal-split { flex-direction: column; }
        .editor-container.horizontal-split .editor-pane { border-right: none; border-bottom: 1px solid #ccc; }
        body.dark-mode .editor-container.horizontal-split .editor-pane { border-bottom-color: #3e3e3e; }

        /* Markdown preview styles */
        .preview-content h1 { font-size: 1.8em; margin: 0.5em 0; border-bottom: 1px solid #eee; padding-bottom: 0.3em; }
        .preview-content h2 { font-size: 1.5em; margin: 0.5em 0; border-bottom: 1px solid #eee; padding-bottom: 0.3em; }
        .preview-content h3 { font-size: 1.3em; margin: 0.5em 0; }
        .preview-content h4, .preview-content h5, .preview-content h6 { font-size: 1.1em; margin: 0.5em 0; }
        .preview-content p { margin: 0.8em 0; line-height: 1.6; }
        .preview-content ul, .preview-content ol { margin: 0.8em 0; padding-left: 2em; }
        .preview-content li { margin: 0.3em 0; }
        .preview-content code { font-family: 'Consolas', monospace; background: #f4f4f4; padding: 2px 5px; border-radius: 3px; font-size: 0.9em; }
        .preview-content pre { background: #2d2d2d; color: #ccc; padding: 12px; border-radius: 5px; overflow-x: auto; margin: 1em 0; }
        .preview-content pre code { background: none; padding: 0; color: inherit; }
        .preview-content blockquote { border-left: 4px solid #ddd; margin: 1em 0; padding: 0.5em 1em; color: #666; background: #f9f9f9; }
        .preview-content table { border-collapse: collapse; margin: 1em 0; width: 100%; }
        .preview-content th, .preview-content td { border: 1px solid #ddd; padding: 8px 12px; text-align: left; }
        .preview-content th { background: #f5f5f5; font-weight: bold; }
        .preview-content a { color: #0066cc; }
        .preview-content img { max-width: 100%; }
        .preview-content hr { border: none; border-top: 1px solid #ddd; margin: 1.5em 0; }

        /* Syntax highlighting */
        .hljs-keyword, .hljs-selector-tag { color: #c678dd; }
        .hljs-string, .hljs-attr { color: #98c379; }
        .hljs-number { color: #d19a66; }
        .hljs-comment { color: #5c6370; font-style: italic; }
        .hljs-function { color: #61afef; }
        .hljs-title { color: #e5c07b; }
        .hljs-built_in { color: #56b6c2; }

        /* Status bar */
        .statusbar { padding: 4px 8px; background: #e0e0e0; border-top: 1px solid #ccc; font-size: 11px; color: #666; display: flex; justify-content: space-between; }

        /* Tab bar styles */
        .tab-bar {
            display: flex;
            background: #2d2d2d;
            border-bottom: 1px solid #3e3e3e;
            overflow-x: auto;
            overflow-y: hidden;
            min-height: 32px;
            scrollbar-width: thin;
            scrollbar-color: #555 #2d2d2d;
        }
        .tab-bar::-webkit-scrollbar { height: 6px; }
        .tab-bar::-webkit-scrollbar-track { background: #2d2d2d; }
        .tab-bar::-webkit-scrollbar-thumb { background: #555; border-radius: 3px; }
        .tab-bar::-webkit-scrollbar-thumb:hover { background: #666; }

        .tab {
            display: flex;
            align-items: center;
            padding: 6px 12px;
            background: #252525;
            color: #888;
            border-right: 1px solid #3e3e3e;
            cursor: pointer;
            white-space: nowrap;
            font-size: 12px;
            min-width: 80px;
            max-width: 200px;
            user-select: none;
        }
        .tab:hover { background: #333; color: #aaa; }
        .tab.active { background: #1e1e1e; color: #d4d4d4; border-bottom: 2px solid #007acc; }
        .tab .tab-title { flex: 1; overflow: hidden; text-overflow: ellipsis; }
        .tab .tab-dirty { color: #ffc107; margin-right: 4px; font-weight: bold; }
        .tab .tab-close {
            margin-left: 8px;
            padding: 2px 4px;
            border-radius: 3px;
            font-size: 14px;
            line-height: 1;
            color: #888;
        }
        .tab .tab-close:hover { background: #555; color: #fff; }
        .tab.active .tab-close { color: #aaa; }
        .tab.active .tab-close:hover { background: #555; color: #fff; }

        /* Tab context menu */
        .tab-context-menu {
            position: fixed;
            background: #2d2d2d;
            border: 1px solid #3e3e3e;
            border-radius: 4px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.4);
            z-index: 10000;
            min-width: 180px;
            padding: 4px 0;
            display: none;
        }
        .tab-context-menu.visible { display: block; }
        .tab-context-menu-item {
            padding: 8px 16px;
            color: #ccc;
            cursor: pointer;
            font-size: 12px;
        }
        .tab-context-menu-item:hover { background: #3e3e3e; color: #fff; }
        .tab-context-menu-separator {
            height: 1px;
            background: #3e3e3e;
            margin: 4px 0;
        }

        /* Light mode tab bar overrides */
        body:not(.dark-mode) .tab-bar { background: #e8e8e8; border-bottom-color: #ccc; }
        body:not(.dark-mode) .tab-bar::-webkit-scrollbar-track { background: #e8e8e8; }
        body:not(.dark-mode) .tab-bar::-webkit-scrollbar-thumb { background: #aaa; }
        body:not(.dark-mode) .tab { background: #ddd; color: #666; border-right-color: #ccc; }
        body:not(.dark-mode) .tab:hover { background: #d0d0d0; color: #444; }
        body:not(.dark-mode) .tab.active { background: #fff; color: #333; border-bottom-color: #007acc; }
        body:not(.dark-mode) .tab .tab-close { color: #888; }
        body:not(.dark-mode) .tab .tab-close:hover { background: #bbb; color: #333; }
        body:not(.dark-mode) .tab-context-menu { background: #fff; border-color: #ccc; }
        body:not(.dark-mode) .tab-context-menu-item { color: #333; }
        body:not(.dark-mode) .tab-context-menu-item:hover { background: #e0e0e0; color: #000; }
        body:not(.dark-mode) .tab-context-menu-separator { background: #ddd; }

        /* Dark mode */
        body.dark-mode .container { background: #1e1e1e; }
        body.dark-mode .format-toolbar { background: #2d2d2d; border-bottom-color: #3e3e3e; }
        body.dark-mode .format-toolbar button { background: #3e3e3e; border-color: #555; color: #ccc; }
        body.dark-mode .format-toolbar button:hover { background: #4e4e4e; }
        body.dark-mode .format-toolbar button:active { background: #5e5e5e; }
        body.dark-mode .editor-pane { border-right-color: #3e3e3e; }
        body.dark-mode .editor-pane .pane-header { background: #252525; color: #aaa; }
        body.dark-mode .editor-pane textarea { background: #1e1e1e; color: #d4d4d4; }
        body.dark-mode .preview-pane .pane-header { background: #252525; color: #aaa; }
        body.dark-mode .preview-pane .pane-header label { color: #aaa; }
        body.dark-mode .preview-pane .pane-header .toggle-btn { background: #3e3e3e; border-color: #555; color: #ccc; }
        body.dark-mode .preview-pane .pane-header .toggle-btn:hover { background: #4e4e4e; }
        body.dark-mode .preview-pane .preview-content { background: #1e1e1e; color: #d4d4d4; }
        body.dark-mode .preview-content h1, body.dark-mode .preview-content h2 { border-bottom-color: #3e3e3e; }
        body.dark-mode .preview-content code { background: #2d2d2d; color: #d4d4d4; }
        body.dark-mode .preview-content pre { background: #0d0d0d; color: #d4d4d4; }
        body.dark-mode .preview-content blockquote { border-left-color: #555; background: #252525; color: #aaa; }
        body.dark-mode .preview-content table th, body.dark-mode .preview-content table td { border-color: #3e3e3e; }
        body.dark-mode .preview-content table th { background: #252525; }
        body.dark-mode .preview-content a { color: #4da6ff; }
        body.dark-mode .preview-content hr { border-top-color: #3e3e3e; }
        body.dark-mode .statusbar { background: #252525; border-top-color: #3e3e3e; color: #aaa; }

        /* Start Page Styles - Light Mode (default) */
        .start-page {
            display: flex;
            justify-content: center;
            align-items: flex-start;
            padding: 40px;
            background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
            overflow: auto;
            flex: 1;
        }
        .start-page-content {
            max-width: 800px;
            width: 100%;
        }
        .start-page-banner {
            text-align: center;
            margin-bottom: 40px;
            padding: 30px;
            background: #fff;
            border-radius: 12px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.08);
        }
        .start-page-title {
            font-size: 2.2em;
            color: #2d3436;
            font-weight: 600;
            margin: 0 0 10px 0;
        }
        .start-page-subtitle {
            font-size: 1.1em;
            color: #636e72;
            margin: 0;
        }
        .start-page-dark-btn {
            margin-top: 20px;
            padding: 8px 16px;
            border: 1px solid #ddd;
            background: #f5f5f5;
            border-radius: 6px;
            cursor: pointer;
            font-size: 13px;
            color: #555;
            transition: background 0.2s, border-color 0.2s;
        }
        .start-page-dark-btn:hover {
            background: #e8e8e8;
            border-color: #ccc;
        }
        body.dark-mode .start-page-dark-btn {
            background: #3e3e3e;
            border-color: #555;
            color: #ccc;
        }
        body.dark-mode .start-page-dark-btn:hover {
            background: #4e4e4e;
            border-color: #666;
        }
        .start-page-actions {
            display: flex;
            gap: 16px;
            justify-content: center;
            margin-bottom: 40px;
        }
        .start-page-btn {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 14px 28px;
            background: #007acc;
            color: #fff;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 500;
            transition: background 0.2s, transform 0.1s;
        }
        .start-page-btn:hover {
            background: #005a9e;
            transform: translateY(-1px);
        }
        .start-page-btn:active {
            transform: translateY(0);
        }
        .start-page-btn .btn-icon {
            font-size: 18px;
        }
        .start-page-recent {
            background: #fff;
            border-radius: 12px;
            padding: 24px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.08);
        }
        .recent-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-bottom: 1px solid #eee;
            padding-bottom: 12px;
            margin-bottom: 12px;
        }
        .recent-header h2 {
            margin: 0;
            font-size: 1.2em;
            color: #2d3436;
            font-weight: 600;
        }
        .recent-action-btn {
            padding: 6px 12px;
            border: 1px solid #ddd;
            background: #fff;
            border-radius: 4px;
            cursor: pointer;
            font-size: 12px;
            color: #666;
            transition: background 0.2s, border-color 0.2s;
        }
        .recent-action-btn:hover {
            background: #f5f5f5;
            border-color: #ccc;
        }
        .recent-files-list {
            display: flex;
            flex-direction: column;
            gap: 4px;
        }
        .recent-file-item {
            display: flex;
            flex-direction: row;
            align-items: center;
            padding: 10px;
            border-radius: 6px;
            cursor: pointer;
            transition: background 0.15s;
        }
        .recent-file-item:hover {
            background: #f5f7fa;
        }
        .recent-file-info {
            flex: 1;
            min-width: 0;
        }
        .recent-file-name {
            font-weight: 500;
            color: #2d3436;
            margin-bottom: 2px;
        }
        .recent-file-path {
            font-size: 11px;
            color: #888;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        .recent-file-date {
            font-size: 11px;
            color: #888;
            margin-right: 12px;
            white-space: nowrap;
        }
        .recent-file-remove {
            opacity: 0;
            padding: 4px 8px;
            border: none;
            background: transparent;
            cursor: pointer;
            font-size: 16px;
            color: #888;
            border-radius: 4px;
            transition: opacity 0.15s, color 0.15s, background 0.15s;
        }
        .recent-file-item:hover .recent-file-remove {
            opacity: 1;
        }
        .recent-file-remove:hover {
            color: #e74c3c;
            background: rgba(231,76,60,0.1);
        }
        .recent-empty {
            text-align: center;
            padding: 40px;
            color: #888;
        }
        .recent-empty p {
            margin: 0;
        }

        /* Start Page Styles - Dark Mode */
        body.dark-mode .start-page {
            background: linear-gradient(135deg, #1e1e1e 0%, #252525 100%);
        }
        body.dark-mode .start-page-banner {
            background: #2d2d2d;
            box-shadow: 0 2px 8px rgba(0,0,0,0.3);
        }
        body.dark-mode .start-page-title {
            color: #d4d4d4;
        }
        body.dark-mode .start-page-subtitle {
            color: #888;
        }
        body.dark-mode .start-page-btn {
            background: #0078d4;
        }
        body.dark-mode .start-page-btn:hover {
            background: #106ebe;
        }
        body.dark-mode .start-page-recent {
            background: #2d2d2d;
            box-shadow: 0 2px 8px rgba(0,0,0,0.3);
        }
        body.dark-mode .recent-header {
            border-bottom-color: #3e3e3e;
        }
        body.dark-mode .recent-header h2 {
            color: #d4d4d4;
        }
        body.dark-mode .recent-action-btn {
            background: #3e3e3e;
            border-color: #555;
            color: #ccc;
        }
        body.dark-mode .recent-action-btn:hover {
            background: #4e4e4e;
            border-color: #666;
        }
        body.dark-mode .recent-file-item:hover {
            background: #3e3e3e;
        }
        body.dark-mode .recent-file-name {
            color: #d4d4d4;
        }
        body.dark-mode .recent-file-path,
        body.dark-mode .recent-file-date {
            color: #888;
        }
        body.dark-mode .recent-file-remove {
            color: #888;
        }
        body.dark-mode .recent-file-remove:hover {
            color: #e74c3c;
            background: rgba(231,76,60,0.15);
        }
        body.dark-mode .recent-empty {
            color: #888;
        }

        /* About Dialog Modal */
        .about-modal-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            z-index: 10000;
            justify-content: center;
            align-items: center;
        }
        .about-modal-overlay.visible {
            display: flex;
        }
        .about-modal {
            background: #fff;
            border-radius: 8px;
            padding: 30px 40px;
            max-width: 400px;
            text-align: center;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.3);
        }
        .about-modal h1 {
            margin: 0 0 20px 0;
            font-size: 24px;
            color: #333;
        }
        .about-modal .credits {
            margin: 15px 0;
            line-height: 1.8;
            color: #555;
        }
        .about-modal .credits strong {
            color: #333;
        }
        .about-modal .idea {
            margin: 15px 0;
            font-style: italic;
            color: #666;
        }
        .about-modal .website {
            margin: 20px 0 15px 0;
        }
        .about-modal .website a {
            color: #0066cc;
            text-decoration: none;
            font-weight: 500;
        }
        .about-modal .website a:hover {
            text-decoration: underline;
        }
        .about-modal .close-btn {
            margin-top: 15px;
            padding: 8px 24px;
            background: #0066cc;
            color: #fff;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
        }
        .about-modal .close-btn:hover {
            background: #0055aa;
        }
        body.dark-mode .about-modal {
            background: #2d2d2d;
        }
        body.dark-mode .about-modal h1 {
            color: #e0e0e0;
        }
        body.dark-mode .about-modal .credits {
            color: #bbb;
        }
        body.dark-mode .about-modal .credits strong {
            color: #e0e0e0;
        }
        body.dark-mode .about-modal .idea {
            color: #999;
        }
        body.dark-mode .about-modal .website a {
            color: #5599dd;
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- Tab bar for multi-file support -->
        <div class="tab-bar" id="tabBar">
            <!-- Tabs will be dynamically added here -->
        </div>

        <!-- Tab context menu -->
        <div class="tab-context-menu" id="tabContextMenu">
            <div class="tab-context-menu-item" data-action="close">Close</div>
            <div class="tab-context-menu-item" data-action="closeOthers">Close Other Tabs</div>
            <div class="tab-context-menu-item" data-action="closeAll">Close All Tabs</div>
            <div class="tab-context-menu-separator"></div>
            <div class="tab-context-menu-item" data-action="save">Save</div>
            <div class="tab-context-menu-item" data-action="saveAs">Save As...</div>
            <div class="tab-context-menu-separator"></div>
            <div class="tab-context-menu-item" data-action="copyPath">Copy Path</div>
            <div class="tab-context-menu-item" data-action="openFolder">Open Containing Folder</div>
        </div>

        <!-- Start Page (shown when Start Page tab is active) -->
        <div class="start-page" id="startPage" style="display: none;">
            <div class="start-page-content">
                <div class="start-page-banner">
                    <h1 class="start-page-title">Clarion Markdown Editor</h1>
                    <p class="start-page-subtitle">Create and edit Markdown documents with live preview</p>
                    <button class="start-page-dark-btn" id="darkModeBtn" onclick="toggleDarkMode()" title="Toggle dark mode">ðŸŒ“ Dark Mode</button>
                </div>
                <div class="start-page-actions">
                    <button class="start-page-btn" onclick="startPageNewFile()">
                        <span class="btn-icon">+</span>
                        <span class="btn-text">New File</span>
                    </button>
                    <button class="start-page-btn" onclick="startPageOpenFile()">
                        <span class="btn-icon">&#128194;</span>
                        <span class="btn-text">Open File</span>
                    </button>
                </div>
                <div class="start-page-recent">
                    <div class="recent-header">
                        <h2>Recent Files</h2>
                        <button class="recent-action-btn" onclick="startPageRemoveMissingFiles()" title="Remove files that no longer exist">Remove Missing</button>
                    </div>
                    <div class="recent-files-list" id="recentFilesList"></div>
                    <div class="recent-empty" id="recentEmpty" style="display: none;"><p>No recent files</p></div>
                </div>
            </div>
        </div>

        <div class="format-toolbar">
            <button onclick="insertBold()" title="Bold (Ctrl+B)"><b>B</b></button>
            <button onclick="insertItalic()" title="Italic (Ctrl+I)"><i>I</i></button>
            <button onclick="insertCode()" title="Inline Code">&lt;/&gt;</button>
            <button onclick="insertCodeBlock()" title="Code Block">{ }</button>
            <button onclick="insertLink()" title="Link">Link</button>
            <button onclick="insertImage()" title="Image">Img</button>
            <button onclick="insertH1()" title="Heading 1">H1</button>
            <button onclick="insertH2()" title="Heading 2">H2</button>
            <button onclick="insertH3()" title="Heading 3">H3</button>
            <button onclick="insertBulletList()" title="Bullet List">List</button>
            <button onclick="insertNumberList()" title="Numbered List">1.</button>
            <button onclick="insertQuote()" title="Blockquote">"</button>
            <button onclick="insertHr()" title="Horizontal Rule">---</button>
            <button onclick="insertTable()" title="Table">Table</button>
        </div>

        <div class="editor-container">
            <div class="editor-pane">
                <div class="pane-header">MARKDOWN</div>
                <textarea id="editor" spellcheck="false" placeholder="Type your markdown here..." oninput="debouncedUpdatePreview()"></textarea>
            </div>
            <div class="preview-pane" id="previewPane">
                <div class="pane-header">
                    <span class="title">PREVIEW</span>
                    <div>
                        <label style="font-size: 10px; font-weight: normal; margin-right: 8px; cursor: pointer;">
                            <input type="checkbox" id="syncScrollCheckbox" checked onchange="toggleScrollSync()" style="margin-right: 3px; cursor: pointer;">
                            Sync Scroll
                        </label>
                        <button class="toggle-btn" id="toggleBtn" onclick="toggleFullscreen()" title="Toggle fullscreen preview">Expand</button>
                        <button class="toggle-btn" id="splitBtn" onclick="toggleSplitDirection()" title="Switch to horizontal split (stacked)">â¬Œ Vertical</button>
                    </div>
                </div>
                <div class="preview-content" id="preview"></div>
            </div>
        </div>

        <div class="statusbar">
            <span id="status">Ready</span>
            <span id="stats">Lines: 0 | Words: 0</span>
        </div>
    </div>

    <!-- Load Marked.js and Mermaid from CDN (virtual host enables this) -->
    <script src="https://cdn.jsdelivr.net/npm/marked@11/marked.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/mermaid@11/dist/mermaid.min.js"></script>

    <!-- INJECT_HIGHLIGHTJS_CSS -->
    <!-- INJECT_HIGHLIGHTJS_JS -->
    <!-- INJECT_CLARION_LANG -->

    <script>
        // Initialize Mermaid
        if (typeof mermaid !== 'undefined') {
            mermaid.initialize({ 
                startOnLoad: false, 
                theme: 'default',  // 'default' is more colorful than 'dark'
                themeVariables: {
                    primaryColor: '#4a90e2',
                    primaryTextColor: '#fff',
                    primaryBorderColor: '#2e5c8a',
                    lineColor: '#6c757d',
                    secondaryColor: '#82ca9d',
                    tertiaryColor: '#ffc658'
                },
                securityLevel: 'loose'
            });
        }

        // Minimal marked.js implementation for markdown parsing
        var marked = (function() {
            function escape(html) {
                return html.replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;');
            }

            function parse(src) {
                var out = '';
                var lines = src.split('\n');
                var inCode = false, inList = false, listType = '';
                var codeBlock = '', codeLanguage = '', codeFence = '';

                for (var i = 0; i < lines.length; i++) {
                    var line = lines[i];

                    // Fenced code blocks (support 3+ backticks at any indentation)
                    var codeMatch = line.match(/^(\s*)(```+)(\w*)/);
                    if (codeMatch) {
                        var fence = codeMatch[2]; // Get the backticks (```, ````, etc.)
                        if (!inCode) {
                            inCode = true;
                            codeFence = fence; // Remember how many backticks opened it
                            codeLanguage = codeMatch[3]; // Get language from match
                            codeBlock = '';
                        } else if (fence === codeFence) {
                            // Only close if same number of backticks
                            // Check for mermaid diagrams
                            if (codeLanguage === 'mermaid') {
                                out += '<div class="mermaid">' + escape(codeBlock.slice(0,-1)) + '</div>\n';
                            } else {
                                out += '<pre><code class="' + (codeLanguage ? 'language-' + codeLanguage : '') + '">' + escape(codeBlock.slice(0,-1)) + '</code></pre>\n';
                            }
                            inCode = false;
                            codeBlock = '';
                            codeLanguage = '';
                            codeFence = '';
                        } else {
                            // Different number of backticks - treat as content
                            codeBlock += line + '\n';
                        }
                        continue;
                    }
                    if (inCode) { codeBlock += line + '\n'; continue; }

                    // Close list if empty line
                    if (inList && line.trim() === '') {
                        out += '</' + listType + '>\n';
                        inList = false;
                    }

                    // Headers
                    if (line.match(/^#{1,6}\s/)) {
                        var level = line.match(/^#+/)[0].length;
                        var text = line.replace(/^#+\s*/, '');
                        out += '<h' + level + '>' + inline(text) + '</h' + level + '>\n';
                        continue;
                    }

                    // Horizontal rule
                    if (line.match(/^(-{3,}|\*{3,}|_{3,})$/)) {
                        out += '<hr>\n';
                        continue;
                    }

                    // Blockquote
                    if (line.match(/^>\s?/)) {
                        out += '<blockquote>' + inline(line.replace(/^>\s?/, '')) + '</blockquote>\n';
                        continue;
                    }

                    // Unordered list
                    if (line.match(/^[\*\-\+]\s/)) {
                        if (!inList || listType !== 'ul') {
                            if (inList) out += '</' + listType + '>\n';
                            out += '<ul>\n';
                            inList = true;
                            listType = 'ul';
                        }
                        out += '<li>' + inline(line.replace(/^[\*\-\+]\s/, '')) + '</li>\n';
                        continue;
                    }

                    // Ordered list
                    if (line.match(/^\d+\.\s/)) {
                        if (!inList || listType !== 'ol') {
                            if (inList) out += '</' + listType + '>\n';
                            out += '<ol>\n';
                            inList = true;
                            listType = 'ol';
                        }
                        out += '<li>' + inline(line.replace(/^\d+\.\s/, '')) + '</li>\n';
                        continue;
                    }

                    // Paragraph
                    if (line.trim() !== '') {
                        out += '<p>' + inline(line) + '</p>\n';
                    }
                }

                if (inCode) out += '<pre><code>' + escape(codeBlock) + '</code></pre>\n';
                if (inList) out += '</' + listType + '>\n';

                return out;
            }

            function inline(text) {
                // Images
                text = text.replace(/!\[([^\]]*)\]\(([^)]+)\)/g, '<img src="$2" alt="$1">');
                // Links
                text = text.replace(/\[([^\]]+)\]\(([^)]+)\)/g, '<a href="$2">$1</a>');
                // Bold
                text = text.replace(/\*\*([^*]+)\*\*/g, '<strong>$1</strong>');
                text = text.replace(/__([^_]+)__/g, '<strong>$1</strong>');
                // Italic
                text = text.replace(/\*([^*]+)\*/g, '<em>$1</em>');
                text = text.replace(/_([^_]+)_/g, '<em>$1</em>');
                // Inline code
                text = text.replace(/`([^`]+)`/g, '<code>$1</code>');
                return text;
            }

            return { parse: parse };
        })();

        var editor = document.getElementById('editor');
        var preview = document.getElementById('preview');
        var statusEl = document.getElementById('status');
        var statsEl = document.getElementById('stats');
        var editorPane = document.querySelector('.editor-pane');
        var previewPane = document.getElementById('previewPane');
        var toggleBtn = document.getElementById('toggleBtn');
        var formatToolbar = document.querySelector('.format-toolbar');
        var isDirty = false;
        var isFullscreen = false;
        var isStartPageActive = false;  // Track if Start Page is currently shown

        // ====================================
        // Tab Management System
        // ====================================
        var tabs = {};  // { tabId: { content, isDirty, filePath, fileName } }
        var activeTabId = null;
        var contextMenuTabId = null;
        var tabBar = document.getElementById('tabBar');
        var tabContextMenu = document.getElementById('tabContextMenu');

        // Find tab by file path
        function findTabByFilePath(filePath) {
            for (var id in tabs) {
                if (tabs[id].filePath === filePath) {
                    return id;
                }
            }
            return null;
        }

        // Add a new tab or switch to existing one with same file path
        function addTab(tabId, fileName, content, filePath) {
            // Check if a tab with this file path already exists
            var existingTabId = findTabByFilePath(filePath);
            if (existingTabId) {
                switchTab(existingTabId);
                return existingTabId;
            }

            // Save current tab content before adding new one
            if (activeTabId && tabs[activeTabId]) {
                tabs[activeTabId].content = editor.value;
            }

            // Create tab data
            tabs[tabId] = {
                content: content || '',
                isDirty: false,
                filePath: filePath || '',
                fileName: fileName || 'Untitled'
            };

            // Create tab element
            var tabEl = document.createElement('div');
            tabEl.className = 'tab';
            tabEl.setAttribute('data-tab-id', tabId);
            tabEl.innerHTML = '<span class="tab-dirty" style="display:none;">*</span>' +
                              '<span class="tab-title">' + escapeHtml(fileName) + '</span>' +
                              '<span class="tab-close" title="Close">&times;</span>';

            // Tab click handler
            tabEl.addEventListener('click', function(e) {
                if (e.target.classList.contains('tab-close')) {
                    // Close button clicked
                    e.stopPropagation();
                    notifyCloseTabRequested(tabId);
                } else {
                    switchTab(tabId);
                }
            });

            // Right-click context menu
            tabEl.addEventListener('contextmenu', function(e) {
                e.preventDefault();
                showTabContextMenu(tabId, e.clientX, e.clientY);
            });

            tabBar.appendChild(tabEl);

            // Switch to the new tab
            switchTab(tabId);

            return tabId;
        }

        // Switch to a specific tab
        function switchTab(tabId) {
            // Handle Start Page tab specially
            if (tabId === 'startPage') {
                switchToStartPage();
                return;
            }

            // If switching away from Start Page, hide it
            if (isStartPageActive) {
                hideStartPage();
            }

            if (!tabs[tabId]) return;

            // Save current tab content before switching
            if (activeTabId && tabs[activeTabId] && activeTabId !== tabId && !tabs[activeTabId].isStartPage) {
                tabs[activeTabId].content = editor.value;
            }

            // Update active tab visually
            var allTabs = tabBar.querySelectorAll('.tab');
            allTabs.forEach(function(tab) {
                tab.classList.remove('active');
            });
            var newActiveTab = tabBar.querySelector('[data-tab-id="' + tabId + '"]');
            if (newActiveTab) {
                newActiveTab.classList.add('active');
                // Scroll tab into view if needed
                newActiveTab.scrollIntoView({ behavior: 'smooth', block: 'nearest', inline: 'nearest' });
            }

            // Load the tab's content
            activeTabId = tabId;
            editor.value = tabs[tabId].content;
            isDirty = tabs[tabId].isDirty;
            updatePreview();

            // Notify C#
            notifyTabSwitched(tabId);
        }

        // Close a tab
        function closeTab(tabId) {
            if (!tabs[tabId]) return;

            // Don't allow closing the Start Page
            if (tabId === 'startPage') return;

            // Remove tab element
            var tabEl = tabBar.querySelector('[data-tab-id="' + tabId + '"]');
            if (tabEl) {
                tabEl.remove();
            }

            // Remove tab data
            delete tabs[tabId];

            // If closing the active tab, switch to another
            if (activeTabId === tabId) {
                // Get remaining tabs excluding Start Page
                var remainingTabIds = Object.keys(tabs).filter(function(id) {
                    return id !== 'startPage';
                });
                if (remainingTabIds.length > 0) {
                    switchTab(remainingTabIds[remainingTabIds.length - 1]);
                } else {
                    // No more file tabs - switch to Start Page
                    switchToStartPage();
                }
            }
        }

        // Update dirty indicator for a tab
        function updateTabDirty(tabId, dirty) {
            if (!tabs[tabId]) return;
            tabs[tabId].isDirty = dirty;

            var tabEl = tabBar.querySelector('[data-tab-id="' + tabId + '"]');
            if (tabEl) {
                var dirtyIndicator = tabEl.querySelector('.tab-dirty');
                if (dirtyIndicator) {
                    dirtyIndicator.style.display = dirty ? 'inline' : 'none';
                }
            }

            // Update global isDirty if this is active tab
            if (tabId === activeTabId) {
                isDirty = dirty;
            }
        }

        // Alias for C# compatibility
        function setTabDirty(tabId, dirty) {
            updateTabDirty(tabId, dirty);
        }

        // Get content of the active tab
        function getActiveTabContent() {
            if (activeTabId && tabs[activeTabId]) {
                // Return current editor value (which is the active tab's content)
                return editor.value();
            }
            return '';
        }

        // Get active tab ID
        function getActiveTabId() {
            return activeTabId;
        }

        // Get tab info
        function getTabInfo(tabId) {
            return tabs[tabId] || null;
        }

        // Get content of a specific tab
        function getTabContent(tabId) {
            if (tabId === activeTabId) {
                // For active tab, return current editor value
                return editor.value();
            }
            if (tabs[tabId]) {
                return tabs[tabId].content;
            }
            return '';
        }

        // Show tab context menu
        function showTabContextMenu(tabId, x, y) {
            contextMenuTabId = tabId;
            tabContextMenu.style.left = x + 'px';
            tabContextMenu.style.top = y + 'px';
            tabContextMenu.classList.add('visible');
        }

        // Hide tab context menu
        function hideTabContextMenu() {
            tabContextMenu.classList.remove('visible');
            contextMenuTabId = null;
        }

        // Handle context menu item click
        function handleContextMenuAction(action) {
            if (!contextMenuTabId) return;

            var tabId = contextMenuTabId;
            hideTabContextMenu();

            switch (action) {
                case 'close':
                    notifyCloseTabRequested(tabId);
                    break;
                case 'closeOthers':
                    notifyContextMenuAction('CloseOthers', tabId);
                    break;
                case 'closeAll':
                    notifyContextMenuAction('CloseAll', tabId);
                    break;
                case 'save':
                    notifyContextMenuAction('Save', tabId);
                    break;
                case 'saveAs':
                    notifyContextMenuAction('SaveAs', tabId);
                    break;
                case 'copyPath':
                    notifyContextMenuAction('CopyPath', tabId);
                    break;
                case 'openFolder':
                    notifyContextMenuAction('OpenContainingFolder', tabId);
                    break;
            }
        }

        // Context menu click handler
        tabContextMenu.addEventListener('click', function(e) {
            var action = e.target.getAttribute('data-action');
            if (action) {
                handleContextMenuAction(action);
            }
        });

        // Hide context menu when clicking elsewhere and notify C# to close menu dropdowns
        document.addEventListener('click', function(e) {
            if (!tabContextMenu.contains(e.target)) {
                hideTabContextMenu();
            }
            notifyDocumentClicked();
        });

        // Hide context menu on escape key
        document.addEventListener('keydown', function(e) {
            if (e.key === 'Escape') {
                hideTabContextMenu();
            }
        });

        // C# notification helpers
        function notifyTabSwitched(tabId) {
            if (window.chrome && window.chrome.webview) {
                window.chrome.webview.postMessage({ type: 'tabSwitched', data: { tabId: tabId } });
            }
        }

        function notifyCloseTabRequested(tabId) {
            if (window.chrome && window.chrome.webview) {
                window.chrome.webview.postMessage({ type: 'closeTabRequested', data: { tabId: tabId } });
            }
        }

        function notifyContextMenuAction(action, tabId) {
            if (window.chrome && window.chrome.webview) {
                window.chrome.webview.postMessage({ type: 'contextMenuAction', data: { action: action, tabId: tabId } });
            }
        }

        function notifyDocumentClicked() {
            if (window.chrome && window.chrome.webview) {
                window.chrome.webview.postMessage({ type: 'documentClicked', data: {} });
            }
        }

        // About dialog functions
        function showAboutDialog() {
            document.getElementById('aboutModal').classList.add('visible');
        }

        function hideAboutDialog() {
            document.getElementById('aboutModal').classList.remove('visible');
        }

        // Close about dialog when clicking overlay or pressing Escape
        document.getElementById('aboutModal').addEventListener('click', function(e) {
            if (e.target === this) {
                hideAboutDialog();
            }
        });

        document.addEventListener('keydown', function(e) {
            if (e.key === 'Escape' && document.getElementById('aboutModal').classList.contains('visible')) {
                hideAboutDialog();
            }
        });

        // HTML escape helper
        function escapeHtml(text) {
            var div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        // Update tab content without marking as dirty (for loading/saving)
        function setTabContent(tabId, content) {
            if (!tabs[tabId]) return;
            tabs[tabId].content = content;
            if (tabId === activeTabId) {
                editor.value = content;
                // Update preview without triggering dirty
                preview.innerHTML = marked.parse(content);
                if (typeof hljs !== 'undefined') {
                    var blocks = preview.querySelectorAll('pre code');
                    blocks.forEach(function(block) {
                        block.removeAttribute('data-highlighted');
                        try { hljs.highlightElement(block); } catch (err) {}
                    });
                }
                if (typeof mermaid !== 'undefined') {
                    var mermaidDivs = preview.querySelectorAll('.mermaid');
                    if (mermaidDivs.length > 0) {
                        requestAnimationFrame(function() {
                            try { mermaid.run({ nodes: mermaidDivs }); } catch (err) {}
                        });
                    }
                }
                updateStats();
            }
        }

        // Get all tabs info (for C# to query state)
        function getAllTabs() {
            var result = [];
            for (var id in tabs) {
                result.push({
                    tabId: id,
                    fileName: tabs[id].fileName,
                    filePath: tabs[id].filePath,
                    isDirty: tabs[id].isDirty
                });
            }
            return result;
        }

        // Update tab file info (e.g., after Save As)
        function updateTabInfo(tabId, fileName, filePath) {
            if (!tabs[tabId]) return;
            tabs[tabId].fileName = fileName;
            tabs[tabId].filePath = filePath;

            // Update tab element
            var tabEl = tabBar.querySelector('[data-tab-id="' + tabId + '"]');
            if (tabEl) {
                var titleEl = tabEl.querySelector('.tab-title');
                if (titleEl) {
                    titleEl.textContent = fileName;
                }
            }
        }

        // Expose tab functions to window for C# access
        window.addTab = addTab;
        window.switchTab = switchTab;
        window.switchToTab = switchTab;  // Alias for C# compatibility
        window.closeTab = closeTab;
        window.removeTab = closeTab;     // Alias for C# compatibility
        window.setTabDirty = setTabDirty;
        window.updateTabDirty = updateTabDirty;
        window.getActiveTabContent = getActiveTabContent;
        window.getActiveTabId = getActiveTabId;
        window.getTabInfo = getTabInfo;
        window.getTabContent = getTabContent;
        window.setTabContent = setTabContent;
        window.getAllTabs = getAllTabs;
        window.updateTabInfo = updateTabInfo;
        window.updateTab = updateTabInfo; // Alias for C# compatibility

        // ====================================
        // End Tab Management System
        // ====================================

        // ====================================
        // Start Page System
        // ====================================

        function initStartPage() {
            // Called after page load - nothing needed currently
        }

        function showStartPage() {
            var startPageEl = document.getElementById('startPage');
            var editorContainer = document.querySelector('.editor-container');
            var formatToolbar = document.querySelector('.format-toolbar');

            if (startPageEl && editorContainer) {
                startPageEl.style.display = 'flex';
                editorContainer.style.display = 'none';
                if (formatToolbar) formatToolbar.style.display = 'none';
                isStartPageActive = true;
            }
        }

        function hideStartPage() {
            var startPageEl = document.getElementById('startPage');
            var editorContainer = document.querySelector('.editor-container');
            var formatToolbar = document.querySelector('.format-toolbar');

            if (startPageEl && editorContainer) {
                startPageEl.style.display = 'none';
                editorContainer.style.display = 'flex';
                if (formatToolbar) formatToolbar.style.display = 'flex';
                isStartPageActive = false;
            }
        }

        function addStartPageTab() {
            // Check if Start Page tab already exists
            if (tabs['startPage']) {
                switchToStartPage();
                return;
            }

            // Create Start Page tab data
            tabs['startPage'] = {
                content: '',
                isDirty: false,
                filePath: '',
                fileName: 'Start Page',
                isStartPage: true
            };

            // Create tab element (no close button - Start Page cannot be closed)
            var tabEl = document.createElement('div');
            tabEl.className = 'tab';
            tabEl.setAttribute('data-tab-id', 'startPage');
            tabEl.innerHTML = '<span class="tab-title">Start Page</span>';

            // Tab click handler
            tabEl.addEventListener('click', function(e) {
                switchToStartPage();
            });

            // Insert at beginning of tab bar
            var tabBarEl = document.getElementById('tabBar');
            if (tabBarEl.firstChild) {
                tabBarEl.insertBefore(tabEl, tabBarEl.firstChild);
            } else {
                tabBarEl.appendChild(tabEl);
            }

            switchToStartPage();
        }

        function switchToStartPage() {
            // Save current tab content before switching
            if (activeTabId && tabs[activeTabId] && !tabs[activeTabId].isStartPage) {
                tabs[activeTabId].content = editor.value;
            }

            // Update active tab visually
            var tabBarEl = document.getElementById('tabBar');
            var allTabs = tabBarEl.querySelectorAll('.tab');
            allTabs.forEach(function(tab) {
                tab.classList.remove('active');
            });
            var startPageTab = tabBarEl.querySelector('[data-tab-id="startPage"]');
            if (startPageTab) {
                startPageTab.classList.add('active');
                startPageTab.scrollIntoView({ behavior: 'smooth', block: 'nearest', inline: 'nearest' });
            }

            activeTabId = 'startPage';
            showStartPage();
        }

        function populateRecentFiles(recentFiles) {
            var listEl = document.getElementById('recentFilesList');
            var emptyEl = document.getElementById('recentEmpty');

            if (!listEl) return;

            listEl.innerHTML = '';

            if (!recentFiles || recentFiles.length === 0) {
                listEl.style.display = 'none';
                if (emptyEl) emptyEl.style.display = 'block';
                return;
            }

            listEl.style.display = 'flex';
            if (emptyEl) emptyEl.style.display = 'none';

            recentFiles.forEach(function(file, index) {
                var itemEl = document.createElement('div');
                itemEl.className = 'recent-file-item';
                itemEl.setAttribute('data-file-path', file.path);

                var existsClass = file.exists ? '' : ' style="opacity: 0.5;"';

                itemEl.innerHTML =
                    '<div class="recent-file-info"' + existsClass + '>' +
                        '<div class="recent-file-name">' + escapeHtml(file.name) + '</div>' +
                        '<div class="recent-file-path">' + escapeHtml(file.path) + '</div>' +
                    '</div>' +
                    '<div class="recent-file-date">' + escapeHtml(file.modifiedDate || '') + '</div>' +
                    '<button class="recent-file-remove" title="Remove from list">&times;</button>';

                // Click to open file
                itemEl.addEventListener('click', function(e) {
                    if (!e.target.classList.contains('recent-file-remove')) {
                        startPageOpenRecentFile(file.path);
                    }
                });

                // Remove button click
                var removeBtn = itemEl.querySelector('.recent-file-remove');
                removeBtn.addEventListener('click', function(e) {
                    e.stopPropagation();
                    startPageRemoveRecentFile(index);
                });

                listEl.appendChild(itemEl);
            });
        }

        // Start Page action handlers
        function startPageNewFile() {
            if (window.chrome && window.chrome.webview) {
                window.chrome.webview.postMessage({ type: 'startPageAction', data: { action: 'newFile' } });
            }
        }

        function startPageOpenFile() {
            if (window.chrome && window.chrome.webview) {
                window.chrome.webview.postMessage({ type: 'startPageAction', data: { action: 'openFile' } });
            }
        }

        function startPageOpenRecentFile(filePath) {
            if (window.chrome && window.chrome.webview) {
                window.chrome.webview.postMessage({
                    type: 'startPageAction',
                    data: { action: 'openRecentFile', filePath: filePath }
                });
            }
        }

        function startPageRemoveRecentFile(index) {
            if (window.chrome && window.chrome.webview) {
                window.chrome.webview.postMessage({
                    type: 'startPageAction',
                    data: { action: 'removeRecentFile', index: index.toString() }
                });
            }
        }

        function startPageRemoveMissingFiles() {
            if (window.chrome && window.chrome.webview) {
                window.chrome.webview.postMessage({
                    type: 'startPageAction',
                    data: { action: 'removeMissingFiles' }
                });
            }
        }

        // Expose Start Page functions to window for C# access
        window.addStartPageTab = addStartPageTab;
        window.showStartPage = showStartPage;
        window.hideStartPage = hideStartPage;
        window.populateRecentFiles = populateRecentFiles;
        window.switchToStartPage = switchToStartPage;
        window.initStartPage = initStartPage;
        // ====================================
        // End Start Page System
        // ====================================

        // Debouncing for preview updates to prevent system lockup
        var updateTimeout = null;
        var renderGeneration = 0;
        var DEBOUNCE_MS = 150;

        function debouncedUpdatePreview() {
            if (updateTimeout) {
                clearTimeout(updateTimeout);
            }
            updateTimeout = setTimeout(function() {
                updatePreview();
            }, DEBOUNCE_MS);
        }

        function toggleFullscreen() {
            isFullscreen = !isFullscreen;
            if (isFullscreen) {
                editorPane.classList.add('hidden');
                previewPane.classList.add('fullscreen');
                formatToolbar.classList.add('hidden');
                toggleBtn.textContent = 'Split';
                toggleBtn.title = 'Show editor and preview side by side';
            } else {
                editorPane.classList.remove('hidden');
                previewPane.classList.remove('fullscreen');
                formatToolbar.classList.remove('hidden');
                toggleBtn.textContent = 'Expand';
                toggleBtn.title = 'Toggle fullscreen preview';
            }
        }

        var isHorizontalSplit = false;
        function toggleSplitDirection() {
            isHorizontalSplit = !isHorizontalSplit;
            var editorContainer = document.querySelector('.editor-container');
            var splitBtn = document.getElementById('splitBtn');

            if (isHorizontalSplit) {
                editorContainer.classList.add('horizontal-split');
                splitBtn.textContent = 'â¬ Horizontal';
                splitBtn.title = 'Switch to vertical split (side by side)';
            } else {
                editorContainer.classList.remove('horizontal-split');
                splitBtn.textContent = 'â¬Œ Vertical';
                splitBtn.title = 'Switch to horizontal split (stacked)';
            }
        }

        function updatePreview() {
            var currentGeneration = ++renderGeneration;
            var text = editor.value;
            preview.innerHTML = marked.parse(text);

            // Apply syntax highlighting to all code blocks
            var statusMsg = 'Ready';
            if (typeof hljs !== 'undefined') {
                var blocks = preview.querySelectorAll('pre code');
                if (blocks.length > 0) {
                    blocks.forEach(function(block) {
                        // Remove any existing highlighting
                        block.removeAttribute('data-highlighted');
                        try {
                            hljs.highlightElement(block);
                            statusMsg = 'Highlighted ' + blocks.length + ' code block(s)';
                        } catch (err) {
                            statusMsg = 'Highlight error: ' + err.message;
                        }
                    });
                }
            } else {
                statusMsg = 'WARNING: hljs not defined!';
            }

            // Render Mermaid diagrams asynchronously to prevent blocking
            if (typeof mermaid !== 'undefined') {
                var mermaidDivs = preview.querySelectorAll('.mermaid');
                if (mermaidDivs.length > 0) {
                    var diagramCount = mermaidDivs.length;
                    // Use requestAnimationFrame to avoid blocking the UI thread
                    requestAnimationFrame(function() {
                        // Cancel if a newer render has started
                        if (currentGeneration !== renderGeneration) return;
                        try {
                            mermaid.run({
                                nodes: mermaidDivs
                            });
                        } catch (err) {
                            console.error('Mermaid error:', err);
                        }
                    });
                    statusMsg += ' | ' + diagramCount + ' diagram(s)';
                }
            }

            setStatus(statusMsg);
            updateStats();
            isDirty = true;

            // Update active tab dirty state and notify C#
            if (activeTabId && tabs[activeTabId]) {
                tabs[activeTabId].isDirty = true;
                var tabEl = tabBar.querySelector('[data-tab-id="' + activeTabId + '"]');
                if (tabEl) {
                    var dirtyIndicator = tabEl.querySelector('.tab-dirty');
                    if (dirtyIndicator) {
                        dirtyIndicator.style.display = 'inline';
                    }
                }
                // Notify C# about content change
                if (window.chrome && window.chrome.webview) {
                    window.chrome.webview.postMessage({ type: 'contentChanged', tabId: activeTabId });
                }
            }
        }

        function updateStats() {
            var text = editor.value;
            var lines = text.split('\n').length;
            var words = text.trim() ? text.trim().split(/\s+/).length : 0;
            statsEl.textContent = 'Lines: ' + lines + ' | Words: ' + words;
        }
        
        // Scroll synchronization
        var syncingScroll = false;
        var scrollSyncEnabled = true; // Default enabled
        
        function syncScroll(source, target) {
            if (syncingScroll || !scrollSyncEnabled) return;
            
            syncingScroll = true;
            var percentage = source.scrollTop / (source.scrollHeight - source.clientHeight);
            if (isNaN(percentage)) percentage = 0;
            target.scrollTop = percentage * (target.scrollHeight - target.clientHeight);
            
            setTimeout(function() {
                syncingScroll = false;
            }, 10);
        }
        
        function toggleScrollSync() {
            var checkbox = document.getElementById('syncScrollCheckbox');
            scrollSyncEnabled = checkbox.checked;
            
            // When enabling sync, align editor to preview's current position
            if (scrollSyncEnabled) {
                syncScroll(preview, editor);
            }
        }
        
        // Sync editor scroll to preview
        editor.addEventListener('scroll', function() {
            if (scrollSyncEnabled) {
                syncScroll(editor, preview);
            }
        });
        
        // Sync preview scroll to editor
        preview.addEventListener('scroll', function() {
            if (scrollSyncEnabled) {
                syncScroll(preview, editor);
            }
        });
        
        function toggleDarkMode() {
            document.body.classList.toggle('dark-mode');
            var isDark = document.body.classList.contains('dark-mode');

            // Update button text
            var btn = document.getElementById('darkModeBtn');
            if (btn) {
                btn.textContent = isDark ? 'â˜€ï¸ Light Mode' : 'ðŸŒ“ Dark Mode';
            }

            // Notify C# (though we're now handling it in JS)
            if (window.external && window.external.SetDarkMode) {
                window.external.SetDarkMode(isDark);
            }
        }
        
        function setDarkMode(enabled) {
            // Convert string to boolean if needed
            if (typeof enabled === 'string') {
                enabled = enabled === 'true';
            }
            
            if (enabled) {
                document.body.classList.add('dark-mode');
            } else {
                document.body.classList.remove('dark-mode');
            }
            
            // Update button text
            var btn = document.getElementById('darkModeBtn');
            if (btn) {
                btn.textContent = enabled ? 'â˜€ï¸ Light' : 'ðŸŒ“ Dark';
            }
        }

        function setStatus(msg) {
            statusEl.textContent = msg;
            setTimeout(function() { statusEl.textContent = 'Ready'; }, 3000);
        }

        // Called from C# to get editor content
        function getEditorContent() {
            return editor.value;
        }

        // Called from C# to load content (legacy - for backward compatibility)
        // Prefer using addTab for multi-file support
        function loadContent(content, filename) {
            editor.value = content;
            setStatus('Loading: ' + filename);

            // Update preview without marking as dirty (this is a load, not an edit)
            var text = editor.value;
            preview.innerHTML = marked.parse(text);

            // Apply syntax highlighting
            if (typeof hljs !== 'undefined') {
                var blocks = preview.querySelectorAll('pre code');
                blocks.forEach(function(block) {
                    block.removeAttribute('data-highlighted');
                    try { hljs.highlightElement(block); } catch (err) {}
                });
            }

            // Render Mermaid diagrams
            if (typeof mermaid !== 'undefined') {
                var mermaidDivs = preview.querySelectorAll('.mermaid');
                if (mermaidDivs.length > 0) {
                    requestAnimationFrame(function() {
                        try { mermaid.run({ nodes: mermaidDivs }); } catch (err) {}
                    });
                }
            }

            updateStats();
            isDirty = false;
        }

        // Called from C# for messages
        function receiveMessage(type, data) {
            if (type === 'fileSaved') {
                isDirty = false;
                setStatus('Saved: ' + data);
            }
        }

        // Formatting helpers
        function insertBold() { wrapSelection('**', '**'); }
        function insertItalic() { wrapSelection('*', '*'); }
        function insertCode() { wrapSelection('`', '`'); }
        function insertCodeBlock() { wrapSelection('\n```\n', '\n```\n'); }
        function insertH1() { insertAtLineStart('# '); }
        function insertH2() { insertAtLineStart('## '); }
        function insertH3() { insertAtLineStart('### '); }
        function insertBulletList() { insertAtLineStart('- '); }
        function insertNumberList() { insertAtLineStart('1. '); }
        function insertQuote() { insertAtLineStart('> '); }
        function insertHr() { insertText('\n---\n'); }

        function insertLink() {
            var sel = getSelection();
            var url = prompt('Enter URL:', 'https://');
            if (url) {
                insertText('[' + (sel || 'link text') + '](' + url + ')');
            }
        }

        function insertImage() {
            var url = prompt('Enter image URL:', 'https://');
            if (url) {
                var alt = prompt('Enter alt text:', 'image');
                insertText('![' + (alt || 'image') + '](' + url + ')');
            }
        }

        function insertTable() {
            var table = '\n| Header 1 | Header 2 | Header 3 |\n|----------|----------|----------|\n| Cell 1   | Cell 2   | Cell 3   |\n| Cell 4   | Cell 5   | Cell 6   |\n';
            insertText(table);
        }

        function wrapSelection(before, after) {
            var start = editor.selectionStart;
            var end = editor.selectionEnd;
            var text = editor.value;
            var sel = text.substring(start, end) || 'text';
            editor.value = text.substring(0, start) + before + sel + after + text.substring(end);
            editor.selectionStart = start + before.length;
            editor.selectionEnd = start + before.length + sel.length;
            editor.focus();
            updatePreview();
        }

        function insertAtLineStart(prefix) {
            var start = editor.selectionStart;
            var text = editor.value;
            // Find line start
            var lineStart = text.lastIndexOf('\n', start - 1) + 1;
            editor.value = text.substring(0, lineStart) + prefix + text.substring(lineStart);
            editor.selectionStart = editor.selectionEnd = start + prefix.length;
            editor.focus();
            updatePreview();
        }

        function getSelection() {
            return editor.value.substring(editor.selectionStart, editor.selectionEnd);
        }

        function insertText(text) {
            var start = editor.selectionStart;
            var end = editor.selectionEnd;
            var val = editor.value;
            editor.value = val.substring(0, start) + text + val.substring(end);
            editor.selectionStart = editor.selectionEnd = start + text.length;
            editor.focus();
            updatePreview();
        }

        // Keyboard shortcuts
        editor.addEventListener('keydown', function(e) {
            if (e.ctrlKey) {
                if (e.key === 'b' || e.key === 'B') { e.preventDefault(); insertBold(); }
                else if (e.key === 'i' || e.key === 'I') { e.preventDefault(); insertItalic(); }
            }
        });

        // Initialize
        updatePreview();
    </script>

    <!-- About Dialog Modal -->
    <div class="about-modal-overlay" id="aboutModal">
        <div class="about-modal">
            <h1>Markdown Editor</h1>
            <div class="credits">
                <strong>Written by</strong><br>
                John Hickey<br>
                Mark Sarson<br>
                Oleg Fomin<br>
                Claude Code
            </div>
            <div class="idea">
                From an idea by Dinko Bakun
            </div>
            <div class="website">
                <a href="https://www.clarionlive.com" target="_blank">www.clarionlive.com</a>
            </div>
            <button class="close-btn" onclick="hideAboutDialog()">Close</button>
        </div>
    </div>
</body>
</html>
